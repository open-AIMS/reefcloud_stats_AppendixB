---
title: "Appendix B"
subtitle: "CASE‚ÄêSTUDY 2: SIMULATION SCENARIOS"
authors:
  - name: Julie Vercelloni
    corresponding: true
    email: j.vercelloni@aims.gov.au
    affiliations:
      - ref: aims
affiliations:
  - id: aims
    name: Australian Institute of Marine Science
engine: knitr
format:
  html:
    toc: true
    toc-location: left
    title-block-banner: true
    toc-depth: 3
    highlight-style: atom-one
    embed-resources: true
    theme:
      light: flatly
      dark: darkly
    code-overflow: wrap
    code-fold: false
    number-sections: true
    number-depth: 2
    shift-heading-level-by: -1
    crossref:
      lst-title: Code listing
    fig-align: center
    text-align: center
    acm-html: default
css: styles.css
editor:
  markdown:
    wrap: 72
---

```{r setup, chunkOpts, echo = FALSE}
knitr::opts_chunk$set(cache = FALSE, message = FALSE, warning = FALSE)
```
::: {.callout-important}
To be displayed on a big screen. 
:::

### Simulations

This document contains additional results associated with the paper. R codes are available on the source file associated with the report and located on the [GitHub](ADD) repository. 

::: {.callout collapse="true"}
#### R codes
```{r}
#| include: true
#| echo: true
#| eval: false

#setwd("c:/Users/jvercell/OneDrive - Australian Institute of Marine Science/AIMS/01_Research projects/ReefCloud/SP_models/FRK_dev/Spatio-temporal model/Appendix_A")

rm(list=ls())

# Loading packages and functions
source("R/packages.R")
source("R/functions.R")

############ Generate the scenarios 

 ######## Simulation 1 ########
title_of_run <- "High-resolution"
#####Create folders
make_folders(title_of_run)
##### Generate settings
generateSettings(nreefs = 25, nyears = 20)
sparse = FALSE # if different temporal sampling intensities is desired, otherwise annual surveys. 
##### Run the pipeline
source("scripts/run_pipeline.R")

 ######## Simulation 2 ########
title_of_run <- "Medium-resolution"
##### Create folders
make_folders(title_of_run)
##### Generate settings
generateSettings(nreefs = 15, nyears = 10)
sparse = FALSE 
##### Run the pipeline
source("scripts/run_pipeline.R")

 ######## Simulation 3 ########
title_of_run <- "Low-resolution"
##### Create folders
make_folders(title_of_run)
##### Generate settings
generateSettings(nreefs = 5, nyears = 5)
sparse = FALSE 
##### Run the pipeline
source("scripts/run_pipeline.R")

 ######## Simulation 4 ########
title_of_run <- "Sparse-temporal"
##### Create folders
make_folders(title_of_run)
##### Generate settings
generateSettings(nreefs = 49, nyears = 30)
sparse = TRUE 
##### Run the pipeline
source("scripts/run_pipeline.R")

############ Generate predictive performances across all simulations 
source("scripts/model_perf_allsim.R")
```
:::

#### Configuration summary  

```{r}
#| include: true
#| echo: false
#| eval: true
#| cache: false

# Source packages and functions 
source("R/packages.R")
source("R/functions.R")

# Grep names and locations of simulations in the home folder
all_dirs <- list.dirs(full.names = FALSE, recursive = FALSE)
exclude_patterns <- c("R", "scripts", "old", "sp_pipeline", "extra","resources", "extra_scenarios")
included_dirs <- all_dirs[!sapply(all_dirs, function(dir) any(grepl(paste(exclude_patterns, collapse = "|"), dir)))] 
included_dirs <- included_dirs[!grepl("^\\d", included_dirs)]

# Grep the models that ran for each simulations 
file <- list.files(str_glue("{included_dirs}/model_outputs/full_run"),
    full.names = TRUE
  )

# Extract second term and last term without .Rdata
table_data <- data.frame(
  simulation = map_chr(str_split(file, "/"), 1),               
  model = str_remove(str_remove(file, "^.*/"), "\\.Rdata$")) %>%
  dplyr::group_by(simulation) %>%
  dplyr::summarize(
    number_of_models = n(),                            
    model_name = toString(unique(model))  
  )

# Assign figure path
assign("FIGURES_PATH", "/report/extra/", envir = .GlobalEnv)
```
```{r}
#| label: tbl-mod
#| eval: true
#| echo: false
#| tbl-cap: Number of models per simulation. 
knitr::kable(table_data)
```

### Predictive performances 

```{r, fig.width=12, fig.height=12}
#| label: fig-sim
#| eval: true
#| echo: false
#| fig-cap: Performance metrics and model fitting time (in minutes) for the four simulation scenarios.
  
print_attr_plots_level1(
  list_folders = included_dirs,
  name_plot = "model_perf_all"
)
``` 

### Monitoring locations 

```{r, fig.width=15, fig.height=15}
#| results: asis
#| panel: tabset

fig_synthos <- purrr::walk(
  included_dirs, 
  ~ print_attr_plots_level3(
    list_folders = .x, 
    name_plot = "synthos_reef_10K", 
    subtitle = TRUE, 
    plot_labels = TRUE, 
    label = "Regional distribution of the synthetic reefs, where red dots indicate monitoring locations and hexagons represent tier boundaries. A tier is considered a data-tier if it contains a red dot; otherwise, it is classified as a new-tier for the scenario",
    n_cols = 1
  )
)
```

### Data viz

```{r, fig.width=15, fig.height=15}
#| results: asis
#| panel: tabset

fig_synthos <- purrr::walk(
  included_dirs, 
  ~ print_attr_plots_level3(
    list_folders = .x, 
    name_plot = "trend_data_fixed", 
    subtitle = TRUE, 
    plot_labels = TRUE, 
    label = "Generated coral cover (%) values by transect within each reef, with colours representing different sites for the scenario",
    n_cols = 1
  )
)
```

```{r, fig.width=15, fig.height=15}
#| results: asis
#| panel: tabset

fig_synthos <- purrr::walk(
  included_dirs, 
  ~ print_attr_plots_level3(
    list_folders = .x, 
    name_plot = "tile_data_fixed", 
    subtitle = TRUE, 
    plot_labels = TRUE, 
    label = "Temporal patterns of mean coral cover (%) by site within reef. White gaps show years when reefs were not monitored as part of the scenario",
    n_cols = 1
  )
)
```

### Regional trends 

```{r, fig.width=15, fig.height=15}
#| results: asis
#| panel: tabset
 
fig_region <- purrr::walk(
  included_dirs, 
  ~ print_attr_plots_level3(
    list_folders = .x, 
    name_plot = "pred_broad", 
    subtitle = FALSE, 
    plot_labels = TRUE, 
    label = "Regional trend. The black line shows mean values and green shadows 95% credible intervals. The dotted blue line is the true simulated temporal field estimated from the Gaussian Random Markov Field values in the simulation",
    n_cols = 1
  )
)
```

### Model prediction

```{r, fig.width=15, fig.height=15}
#| results: asis
#| panel: tabset

fig_pred <- purrr::walk(
  included_dirs, 
  ~ print_attr_plots_level3(
    list_folders = .x, 
    name_plot = "pred[A-Za-z0-9]+", 
    subtitle = FALSE, 
    plot_labels = TRUE, 
    label = "Predictions of coral cover (%) in",
    n_cols = 1
  )
)
```

### Model uncertainty

```{r, fig.width=15, fig.height=15}
#| results: asis
#| panel: tabset
 
fig_pred_unc <- purrr::walk(
  included_dirs, 
  ~ print_attr_plots_level3(
    list_folders = .x, 
    name_plot = "pred_unc[A-Za-z0-9]+", 
    subtitle = FALSE, 
    plot_labels = TRUE, 
    label = "Uncertainty associated with predicted coral cover values in",
    n_cols = 1
  )
)
```

### Trends at selected locations

```{r, fig.width=15, fig.height=15}
#| results: asis
#| panel: tabset

fig_data <- purrr::walk(
  included_dirs, 
  ~ print_attr_plots_level3(
    list_folders = .x, 
    name_plot = "trends_FRK", 
    subtitle = FALSE, 
    plot_labels = TRUE, 
    label = "Temporal trends at A) data-tiers and B) new-tiers. The black line shows mean values and shaded areas the 95% credible intervals. Grey lines displayed generated coral values for the scenario",
    n_cols = 1
  )
)
```

### Model fit 

```{r, fig.width=15, fig.height=15}
#| label: fig-fit
#| eval: true
#| echo: false
#| fig-cap: Model goodness-of-fit showing predicted coral cover versus true values.  

print_attr_plots_level2(
  list_folders = included_dirs,
  name_plot = "check_true.png"
)
``` 

### Cyclone  
```{r, fig.width=15, fig.height=15}
#| results: asis
#| panel: tabset
  
fig_cyclone <- purrr::walk(
  included_dirs, 
  ~ print_attr_plots_level3(
    list_folders = .x, 
    name_plot = "cyclone", 
    subtitle = FALSE, 
    plot_labels = TRUE, 
    label = "Relative effects of cyclone exposure per surveyed year for the scenario",
    n_cols = 1
  )
)

fig_cyclone
```

### Heat stress 

```{r, fig.width=15, fig.height=15}
#| results: asis
#| panel: tabset
 
fig_dhw <- purrr::walk(
  included_dirs, 
  ~ print_attr_plots_level3(
    list_folders = .x, 
    name_plot = "dhw", 
    subtitle = FALSE, 
    plot_labels = TRUE, 
    label = "Relative effects of heat stress event per surveyed year for the scenario",
    n_cols = 1
  )
)

``` 

